<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Phone Home Data</title>
  <script src="../Build/Cesium/Cesium.js"></script>
  <script src="../node_modules/lodash/lodash.js"></script>
  <style>
      @import url(../Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }

      body {
        background-color: white;
      }

      h1 {
        margin-top: 10px;
        margin-bottom: 10px;
        color: black;
        padding-top: 10px;
        padding-bottom: 10px;
        text-align: center;
        background-color: rgb(240, 240, 240);
        font-family: verdana;
        font-size: 20px;
        border-bottom: 2px solid rgb(240, 5, 70);
      }

      img.logo {
        margin: auto;
        margin-top: 10px;
        display: block;
      }

      .stage {
        display: flex;
        flex-direction: row-reverse;
      }

      .cesium-viewer-bottom .cesium-widget-credits {
        display: none;
      }

      .globalInfo {
        margin-left: 10px;
      }

      table {
        border: none;
        font-family: verdana;
        font-size: 15px;
        font-weight: normal;
        width: 100%;
        text-align: left;
        margin-bottom: 10px;
      }

      td {
        padding-top: 25px;
      }
  </style>
</head>

<body>
  <!--Splits into 2 panels-->
  <div class="stage", style="height:100%">
    <div>
      <img src="https://cdn.worldvectorlogo.com/logos/couchbase.svg" width=400 height="50"
           class="logo">

      <h1>Global Information</h1>

      <div class="globalInfo">
        <button onclick="togglePause()">
          Pause
        </button>

        <table>
          <tr>
            <td>Active Versions</td>
            <td id="active"></td>
          </tr>
          <tr>
            <td>N1QL</td>
            <td id="n1ql"></td>
          </tr>
          <tr>
            <td>KV</td>
            <td id="kv"></td>
          </tr>
          <tr>
            <td>Index</td>
            <td id="index"></td>
          </tr>
          <tr>
            <td>Enterprise</td>
            <td>Community</td>
          </tr>
        </table>

        <svg height="210" width="500" id="barChart"></svg>
      </div>
    </div>

    <div id="cesiumContainer"></div>
  </div>

  <script>
    var viewer = new Cesium.Viewer('cesiumContainer', {timeline : false, animation : false});

    var pause = false;
    function togglePause() {
      pause = !pause
    }

    var spinHeight = viewer.camera.positionCartographic.height - 10000;
    function fly() {
      if (!pause && viewer.camera.positionCartographic.height >= spinHeight) {
        viewer.camera.rotate(new Cesium.Cartesian3(0.0, 0.0, 1.0), 0.0005)
      }
    }
    setInterval(fly, 20)

    //Function for plotting points
    function addResult(result, path, factor) {
      var amount = _.get(result, path, 0)

      var surfacePosition = Cesium.Cartesian3.fromDegrees(result.longitude, result.latitude, 0);
      var heightPosition = Cesium.Cartesian3.fromDegrees(result.longitude, result.latitude, Math.sqrt(amount) * factor);
      var color = Cesium.Color.fromHsl((1.0 - (result.count * 0.013)), 1.0, 0.5);

      //Green/blue color scheme: (0.55 - (result.count * 0.013)), 1.0, 0.5
      //Red/purple color scheme: (1.0 - (result.count * 0.013)), 1.0, 0.5

      var polyline = new Cesium.PolylineGraphics();
            polyline.material = new Cesium.ColorMaterialProperty(color);
            polyline.width = new Cesium.ConstantProperty(3);
            polyline.followSurface = new Cesium.ConstantProperty(false);
            polyline.positions = new Cesium.ConstantProperty([surfacePosition, heightPosition]);

      var line = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(i, 40),
        name : result.addr,
        description : 
          '<pre>' + JSON.stringify(result, null, 2) + '</pre>',
        polyline : polyline
      });
    }

    var i = 0;
    //Plot lat/lon of phonehome data
    function addResults(results, path, factor) {
      while (i < results.length) {
        addResult(results[i], path, factor)
        i = i + 1
      }
    }

    //Variables to parse into global data
    var activeEl = document.getElementById("active");
    var n1qlEl = document.getElementById("n1ql");
    var kvEl = document.getElementById("kv");
    var indexEl = document.getElementById("index");

    var gdata

    //Loads map data
    function loadDoc(query) {
      console.log(query)

      // Parse the JSON string to send REST API request
      var json_req = JSON.stringify({
        "statement": query,
        "creds": [{
          "user": "Administrator",
          "pass": "password"
        }]
      })

      //Requests server for data
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        console.log("xhttp.status: " + xhttp.status);

        if (this.readyState >= 3 && this.status == 200) {
          var response = JSON.parse(this.responseText)
          //Plots the lines
          addResults(response.results, "count", 1000000);

          return response.results[0]
        } else {
          // handle query errors here
          console.log("xhttp error")
          }
      };
      xhttp.open("POST", "http://localhost:8080/proxy/http://Administrator:password@172.23.99.8:8093/query/service");
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(json_req);
    };

    //Loads global data
    function loadGlobal(query) {
      console.log(query)

      // Parse the JSON string to send REST API request
      var json_req = JSON.stringify({
        "statement": query,
        "creds": [{
          "user": "Administrator",
          "pass": "password"
        }]
      })

      //Requests server for data
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        console.log("xhttp.responseText: " + xhttp.responseText);
        console.log("xhttp.status: " + xhttp.status);

        if (this.readyState >= 3 && this.status == 200) {
          gdata = JSON.parse(this.responseText)
          console.log("gdata: " + gdata.results[0])
          console.log(gdata.results[0])

          //Query to find total enterprise customers
          var enterpriseQuery;
          enterpriseQuery = "SELECT COUNT(phonehome.version) AS enterprise FROM phonehome_sample WHERE phonehome.version LIKE \"%enterprise\""
          loadEnterprise(enterpriseQuery);

          activeEl.innerHTML = JSON.stringify(gdata.results[0].activenodes);
          n1qlEl.innerHTML = JSON.stringify(gdata.results[0].n1qlnodes);
          kvEl.innerHTML = JSON.stringify(gdata.results[0].kvnodes);
          indexEl.innerHTML = JSON.stringify(gdata.results[0].indexnodes);

          return gdata.results[0]
        } else {
          // handle query errors here
          console.log("xhttp error")
          }
      };
      xhttp.open("POST", "http://localhost:8080/proxy/http://Administrator:password@172.23.99.8:8093/query/service");
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(json_req);
    };

    //Loads enterprise data
    function loadEnterprise(query) {
      console.log(query)

      // Parse the JSON string to send REST API request
      var json_req = JSON.stringify({
        "statement": query,
        "creds": [{
          "user": "Administrator",
          "pass": "password"
        }]
      })

      //Requests server for data
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        console.log("xhttp.responseText: " + xhttp.responseText);
        console.log("xhttp.status: " + xhttp.status);

        if (this.readyState >= 3 && this.status == 200) {
          var edata = JSON.parse(this.responseText)
          console.log("edata: " + edata.results[0])
          console.log(edata.results[0])

          var barWidth = 370
          var pct = 1.0 * edata.results[0].enterprise / (1.0 * gdata.results[0].activenodes)
          var pctWidth = barWidth * pct

          var barChartEl = document.getElementById("barChart");
          barChartEl.innerHTML = 
            '<line x1="4" y1="0" x2="' + barWidth + '" y2="0" style="stroke:rgb(5, 100, 240);stroke-width:50" />' +
            '<line x1="4" y1="0" x2="' + pctWidth + '" y2="0" style="stroke:rgb(240, 5, 70);stroke-width:50" />'

          return edata.results[0]
        } else {
          // handle query errors here
          console.log("xhttp error")
          }
      };
      xhttp.open("POST", "http://localhost:8080/proxy/http://Administrator:password@172.23.99.8:8093/query/service");
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(json_req);
    };

    //Query to find data to plot onto the map
    var mapQuery;
    mapQuery = "SELECT phonehome.geo.latitude, phonehome.geo.longitude, phonehome.geo.cityName, phonehome.geo.countryCode, phonehome.nodes.services, phonehome.addr, phonehome.active_version, phonehome.version, phonehome.isEnterpriseEdition, COUNT(*) AS count FROM phonehome_sample GROUP BY phonehome.geo.latitude, phonehome.geo.longitude, phonehome.geo.cityName, phonehome.geo.countryCode, phonehome.nodes.services, phonehome.addr, phonehome.active_version, phonehome.version, phonehome.isEnterpriseEdition ORDER BY phonehome.geo.latitude ASC"
    loadDoc(mapQuery);

    //Query to find global data
    var globalQuery;
    globalQuery = "SELECT COUNT(phonehome.nodes.services.`index`) AS indexnodes, SUM(phonehome.nodes.services.kv) AS kvnodes, SUM(phonehome.nodes.services.n1ql) AS n1qlnodes, COUNT(phonehome.active_version) AS activenodes FROM phonehome_sample WHERE phonehome.active_version = true;"
    loadGlobal(globalQuery);      
  </script>
</body>
</html>
