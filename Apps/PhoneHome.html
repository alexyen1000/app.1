<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Phone Home Data</title>
  <script src="../Build/Cesium/Cesium.js"></script>
  <style>
      @import url(../Build/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
          width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }

      body {
        background-color: white;
      }

      h1{
        margin-top: 10px;
        margin-bottom: 0px;
        color: black;
        padding-top: 10px;
        padding-bottom: 10px;
        text-align: center;
        background-color: rgb(242, 242, 242);
        font-family: verdana;
        font-size: 20px;
      }

      image {
      }

  </style>
</head>
<body>
  <style type="text/css">
  .stage {
    display: flex;
    flex-direction: row-reverse;
  }
  .cesium-viewer-bottom .cesium-widget-credits {
    display: none;
  </style>

  <!--Splits into 2 panels-->
  <div class="stage", style="height:100%">
    <div>
      <image>
        <img src="https://cdn.worldvectorlogo.com/logos/couchbase.svg" alt="logo" width=400 height="50">
      </image>
      <h1>Global Information</h1>
      <svg height="25" width=100%>
        <line x1="0" y1="0" x2=100% y2="0" style="stroke:rgb(240, 2, 73);stroke-width:4" />
      </svg>
      <button onclick="togglePause()">
        Pause
      </button>
      <p> N1QL: <pre id="demo2"></pre></p>
      KV: <p id="demo3"></p>
      Index: <p id="demo4"></p>
    </div>
    <div id="cesiumContainer"></div>
  </div>

  <script>
    var viewer = new Cesium.Viewer('cesiumContainer', {timeline : false, animation : false});
    var cameraHeight = viewer.camera.positionCartographic.height - 10000;
    var pause = false;
    function togglePause() {
      pause = !pause
    }

    function fly() {
      if (!pause && viewer.camera.positionCartographic.height >= cameraHeight) {
        viewer.camera.rotate(new Cesium.Cartesian3(0.0, 0.0, 1.0), 0.0005)
      }
    }
    setInterval(fly, 20)

    //Function for plotting points
    function addResult(result) {
      var surfacePosition = Cesium.Cartesian3.fromDegrees(result.longitude, result.latitude, 0);
      var heightPosition = Cesium.Cartesian3.fromDegrees(result.longitude, result.latitude, Math.sqrt(result.count) * 1000000);
      var color = Cesium.Color.fromHsl((1.0 - (result.count * 0.013)), 1.0, 0.5);
      //Green/blue color shceme: (0.55 - (result.count * 0.013)), 1.0, 0.5
      //Red/purple color scheme: (1.0 - (result.count * 0.013)), 1.0, 0.5

      var polyline = new Cesium.PolylineGraphics();
            polyline.material = new Cesium.ColorMaterialProperty(color);
            polyline.width = new Cesium.ConstantProperty(3);
            polyline.followSurface = new Cesium.ConstantProperty(false);
            polyline.positions = new Cesium.ConstantProperty([surfacePosition, heightPosition]);

      var line = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(i, 40),
        name : result.addr,
        description : 
          '<pre>' + JSON.stringify(result, null, 2) + '</pre>',
        polyline : polyline
      });
      
    }
    var i = 0;
    //Plot lat/lon of phonehome data
    function addResults(results) {
      while (i < results.length) {
        addResult(results[i])
        i = i + 1
      }
    }
    

/*
    function addPoint(x, y) {
      viewer.entities.add({
        position : Cesium.Cartesian3.fromDegrees(x, y),
        name : 'Point that scales',
        description :
          'n1ql: ' +  data1.results[1].nodes.services.n1ql + '<br/>' +
          'kv: ' + data1.results[1].nodes.services.kv + '<br/>',
        point : {
            pixelSize : 10,
            color : Cesium.Color.BLUE,
            //image : 'https://blog.couchbase.com/wp-content/uploads/2017/02/cropped-Couchbase-Blog-lockup.png',
            scaleByDistance : new Cesium.NearFarScalar(1.5e2, 2.0, 1.5e7, 0.5)
        }
      });
    }

    var i = 0;
    while (i < 360) {
      var r = (Math.random() * 180.0) - 90.0;
      addPoint(i, r)
      i = i + 1
    }
*/
    



    var n1qlEl = document.getElementById("demo2");

    function loadValues() {
      //query to find total enterprise customers
      var globalQuery;
      globalQuery = "SELECT COUNT(phonehome.version) AS enterprise FROM phonehome_sample WHERE phonehome.version LIKE \"%enterprise\""
      //loadDoc(query);

      var mapQuery;
      mapQuery = "SELECT phonehome.geo.latitude, phonehome.geo.longitude, phonehome.geo.cityName, phonehome.geo.countryCode, phonehome.nodes.services, phonehome.addr, phonehome.active_version, phonehome.version, phonehome.isEnterpriseEdition, COUNT(*) AS count FROM phonehome_sample GROUP BY phonehome.geo.latitude, phonehome.geo.longitude, phonehome.geo.cityName, phonehome.geo.countryCode, phonehome.nodes.services, phonehome.addr, phonehome.active_version, phonehome.version, phonehome.isEnterpriseEdition ORDER BY phonehome.geo.latitude ASC"
      loadDoc(mapQuery);
    };

    function loadDoc(query) {
      console.log(query)

      // Parse the JSON string to send REST API request
      var json_req = JSON.stringify({
        "statement": query,
        "creds": [{
          "user": "Administrator",
          "pass": "password"
        }]
      })

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        console.log("xhttp.responseText: " + xhttp.responseText);
        console.log("xhttp.status: " + xhttp.status);

        if (this.readyState >= 3 && this.status == 200) {
          var response = JSON.parse(this.responseText)
          console.log("response: " + response.results[0])
          console.log(response.results[0])
          n1qlEl.innerHTML = JSON.stringify(response.results[0], null, 2);
          addResults(response.results);
          return response.results[0]
        } else {
          // handle query errors here
          console.log("xhttp error")
          }
      };

      xhttp.open("POST", "http://localhost:8080/proxy/http://Administrator:password@172.23.99.8:8093/query/service");
      xhttp.setRequestHeader("Content-Type", "application/json");
      xhttp.send(json_req);
    };
    loadValues();
  </script>
</body>
</html>
